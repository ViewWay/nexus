name: Release

permissions:
  contents: write

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"

jobs:
  version-info:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Get releasing version
        working-directory: .
        run: echo NEXT_VERSION=$(sed -nE 's/^\s*version = "(.*?)"/\1/p' Cargo.toml) >> $GITHUB_ENV

      - name: Check published version
        run: echo PREV_VERSION=$(cargo search nexus-runtime --limit 1 | sed -nE 's/^[^"]*"//; s/".*//p') >> $GITHUB_ENV

  publish:
    runs-on: ubuntu-latest
    needs: [version-info]
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        package:
          # Core crates (publish order matters for dependencies)
          # 核心 crate（发布顺序对依赖关系很重要）
          - crate: nexus-runtime
            path: crates/nexus-runtime
          - crate: nexus-core
            path: crates/nexus-core
          - crate: nexus-http
            path: crates/nexus-http
          - crate: nexus-router
            path: crates/nexus-router
          - crate: nexus-extractors
            path: crates/nexus-extractors
          - crate: nexus-response
            path: crates/nexus-response
          - crate: nexus-middleware
            path: crates/nexus-middleware
          - crate: nexus-macros
            path: crates/nexus-macros
          - crate: nexus-resilience
            path: crates/nexus-resilience
          - crate: nexus-observability
            path: crates/nexus-observability
          - crate: nexus-config
            path: crates/nexus-config
          - crate: nexus-cache
            path: crates/nexus-cache
          - crate: nexus-security
            path: crates/nexus-security
          - crate: nexus-tx
            path: crates/nexus-tx
          - crate: nexus-cloud
            path: crates/nexus-cloud
          - crate: nexus-schedule
            path: crates/nexus-schedule
          - crate: nexus-multipart
            path: crates/nexus-multipart
          - crate: nexus-validation
            path: crates/nexus-validation
          - crate: nexus-exceptions
            path: crates/nexus-exceptions
          - crate: nexus-actuator
            path: crates/nexus-actuator
          - crate: nexus-web3
            path: crates/nexus-web3
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Get releasing version
        working-directory: ${{ matrix.package.path }}
        run: echo NEXT_VERSION=$(sed -nE 's/^\s*version = "(.*?)"/\1/p' Cargo.toml) >> $GITHUB_ENV

      - name: Check published version
        run: echo PREV_VERSION=$(cargo search ${{ matrix.package.crate }} --limit 1 | sed -nE 's/^[^"]*"//; s/".*//p') >> $GITHUB_ENV

      - name: Cargo login
        if: env.NEXT_VERSION != env.PREV_VERSION
        run: cargo login ${{ secrets.CRATES_TOKEN }}

      - name: Cargo package
        if: env.NEXT_VERSION != env.PREV_VERSION
        working-directory: ${{ matrix.package.path }}
        run: |
          echo "Releasing version: $NEXT_VERSION"
          echo "Published version: $PREV_VERSION"
          echo "Cargo Packaging..."
          cargo package

      - name: Publish ${{ matrix.package.crate }}
        if: env.NEXT_VERSION != env.PREV_VERSION
        working-directory: ${{ matrix.package.path }}
        run: |
          echo "Cargo Publishing..."
          cargo publish --no-verify
          echo "New version $NEXT_VERSION has been published"