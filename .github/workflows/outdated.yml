# Outdated Dependencies Check
# è¿‡æ—¶ä¾èµ–æ£€æŸ¥
#
# This workflow checks for outdated dependencies on a weekly basis.
# æ­¤å·¥ä½œæµæ¯å‘¨æ£€æŸ¥è¿‡æ—¶çš„ä¾èµ–é¡¹ã€‚

name: Check Outdated Dependencies

permissions:
  contents: read
  issues: write

on:
  schedule:
    # Run every Monday at 09:00 Asia/Shanghai
    # æ¯å‘¨ä¸€ 09:00 äºšæ´²/ä¸Šæµ·æ—¶é—´è¿è¡Œ
    - cron: '0 1 * * 1'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  outdated:
    name: Check Outdated Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-outdated
        run: cargo install cargo-outdated

      - name: Check for outdated dependencies
        run: |
          cargo outdated --workspace --exit-code 1 > outdated.txt 2>&1 || true
          cargo outdated --workspace --depth 1 >> outdated.txt 2>&1 || true

      - name: Generate outdated report
        run: |
          echo "## ðŸ“¦ Outdated Dependencies Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Generated on: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat outdated.txt >> $GITHUB_STEP_SUMMARY || echo "No outdated dependencies found!" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "If outdated dependencies are found:" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the changes for each dependency" >> $GITHUB_STEP_SUMMARY
          echo "2. Check for breaking changes" >> $GITHUB_STEP_SUMMARY
          echo "3. Test updates in a feature branch" >> $GITHUB_STEP_SUMMARY
          echo "4. Update using Dependabot or manually" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Manual Update Commands" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Update all dependencies" >> $GITHUB_STEP_SUMMARY
          echo "cargo update" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Update specific dependency" >> $GITHUB_STEP_SUMMARY
          echo "cargo update -p crate-name" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload outdated report
        uses: actions/upload-artifact@v4
        with:
          name: outdated-dependencies
          path: outdated.txt
          retention-days: 30

  # ==============================================================================
  # Security Updates / å®‰å…¨æ›´æ–°
  # ==============================================================================
  security-updates:
    name: Check Security Updates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: |
          cargo audit --json > audit-report.json 2>&1 || true

      - name: Generate security report
        if: always()
        run: |
          echo "## ðŸ”’ Security Audit Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Generated on: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat audit-report.json >> $GITHUB_STEP_SUMMARY || echo "No vulnerabilities found!" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        with:
          name: security-audit
          path: audit-report.json
          retention-days: 30

  # ==============================================================================
  # Create Issue (Optional) / åˆ›å»º Issueï¼ˆå¯é€‰ï¼‰
  # ==============================================================================
  create-issue:
    name: Create Issue for Outdated Deps
    runs-on: ubuntu-latest
    needs: [outdated, security-updates]
    if: github.event_name == 'schedule'
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create issue if needed
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const outdated = fs.readFileSync('artifacts/outdated-dependencies/outdated.txt', 'utf8');
            const audit = JSON.parse(fs.readFileSync('artifacts/security-audit/audit-report.json', 'utf8'));

            if (outdated.includes('Name') || audit.vulnerabilities?.length > 0) {
              const title = `ðŸ“¦ Dependency Updates Needed - ${new Date().toISOString().split('T')[0]}`;
              const body = `## Outdated Dependencies\n\n\`\`\`\n${outdated}\n\`\`\`\n\n## Security Vulnerabilities\n\n\`\`\`json\n${JSON.stringify(audit, null, 2)}\n\`\`\`\n\nAutomated workflow detected updates needed.`;

              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['dependencies', 'security', 'automated']
              });
            }
