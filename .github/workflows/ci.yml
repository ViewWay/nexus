# Nexus Framework CI/CD Pipeline
# Nexus框架 CI/CD流水线
#
# This workflow builds, tests, and validates the entire codebase.
# 此工作流构建、测试和验证整个代码库。

name: CI
permissions:
  contents: read
  pull-requests: read

on:
  push:
    branches: [main, develop]
    tags: ['v*']
  pull_request:
    branches: [main, develop]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Dependency review job / 依赖审查任务
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          deny-licenses: GPL-2.0, GPL-3.0, AGPL-3.0

  # Lint job / Lint任务
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy (enhanced)
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

      # Check documentation for public APIs only.
      # 检查公共API的文档。
      #
      # Note: --document-private-items is disabled due to rustdoc SIGABRT crash
      #       with Rust 1.93 and complex workspaces using edition 2024.
      #       Public API documentation is still validated with -D warnings.
      # 注意：由于 Rust 1.93 和使用 edition 2024 的复杂工作空间导致
      #       rustdoc SIGABRT 崩溃，--document-private-items 被禁用。
      #       公共 API 文档仍使用 -D warnings 进行验证。
      - name: Check documentation
        run: cargo doc --no-deps --all-features -- -D warnings

  # Build and test job / 构建和测试任务
  test:
    name: Test
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable, nightly]
    runs-on: ${{ matrix.os }}
    continue-on-error: ${{ matrix.rust == 'nightly' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}

      - name: Build workspace
        run: cargo build --workspace --all-targets

      - name: Run tests
        run: cargo test --workspace --all-features

      - name: Run doc tests
        run: cargo test --doc

  # Security audit job / 安全审计任务
  security:
    name: Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Run cargo audit
        uses: rustsec/audit-check@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  # Code coverage job / 代码覆盖率任务
  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install tarpaulin
        run: cargo install cargo-tarpaulin

      - name: Generate coverage report
        run: cargo tarpaulin --workspace --all-features --out Xml

      - name: Upload to codecov.io
        uses: codecov/codecov-action@v4
        with:
          files: ./cobertura.xml
