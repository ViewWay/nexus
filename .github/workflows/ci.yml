# Nexus Framework CI/CD Pipeline
# Nexus框架 CI/CD流水线
#
# Consolidated CI workflow combining:
# - Original ci.yml (lint, test, security)
# - linux.yml, macos.yml, windows.yml (platform tests)
# - quality.yml (code quality checks)
#
# 参考设计: Axum, Actix-web

name: CI

permissions:
  contents: read
  pull-requests: read
  checks: write  # For clippy annotations

on:
  push:
    branches: [main, develop]
    tags: ['v*']
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  MSRV: '1.93'

jobs:
  # ==============================================================================
  # Lint Job / Lint任务
  # ==============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

      - name: Check documentation
        run: cargo doc --no-deps --all-features -- -D warnings

  # ==============================================================================
  # MSRV Check / MSRV 检查
  # ==============================================================================
  msrv:
    name: Check MSRV
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Rust toolchain (MSRV)
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ env.MSRV }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-msrv-${{ hashFiles('**/Cargo.lock') }}

      - name: Check with MSRV
        run: cargo check --workspace --bins --examples --tests

  # ==============================================================================
  # Typos Check / 拼写检查
  # ==============================================================================
  typos:
    name: Typos
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Check spelling
        uses: crate-ci/typos@v1.29.4

  # ==============================================================================
  # Dependency Check / 依赖检查
  # ==============================================================================
  deny:
    name: Dependency Check (cargo-deny)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Run cargo-deny
        uses: EmbarkStudios/cargo-deny-action@v2
        with:
          command: check advisories bans licenses sources

  # ==============================================================================
  # Feature Combinations / 特性组合检查
  # ==============================================================================
  feature-powerset:
    name: Feature Powerset
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Rust toolchain (nightly)
        uses: dtolnay/rust-toolchain@nightly

      - name: Install cargo-hack
        uses: taiki-e/install-action@cargo-hack

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-hack-${{ hashFiles('**/Cargo.lock') }}

      - name: Check feature powerset (depth 2)
        run: cargo hack check --feature-powerset --depth 2 --workspace

  # ==============================================================================
  # Build and Test / 构建和测试
  # ==============================================================================
  test:
    name: Test (${{ matrix.os }}, ${{ matrix.rust }})
    needs: [lint]
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - os: ubuntu-latest
            rust: stable
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-latest
            rust: nightly
            target: x86_64-unknown-linux-gnu
          # macOS
          - os: macos-latest
            rust: stable
            target: x86_64-apple-darwin
          # Windows
          - os: windows-latest
            rust: stable
            target: x86_64-pc-windows-msvc

    runs-on: ${{ matrix.os }}
    continue-on-error: ${{ matrix.rust == 'nightly' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
          target: ${{ matrix.target }}

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ matrix.rust }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ matrix.rust }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-${{ matrix.rust }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Build workspace
        run: cargo build --workspace --all-targets

      - name: Run tests
        run: cargo test --workspace --all-features

      - name: Run doc tests
        run: cargo test --doc

  # ==============================================================================
  # Security Audit / 安全审计
  # ==============================================================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Run cargo audit
        uses: rustsec/audit-check@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  # ==============================================================================
  # CI Pass Summary / CI 通过摘要
  # ==============================================================================
  ci-pass:
    name: CI Green
    runs-on: ubuntu-latest
    needs:
      - lint
      - msrv
      - typos
      - deny
      - feature-powerset
      - test
      - security
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.msrv.result }}" != "success" ] || \
             [ "${{ needs.typos.result }}" != "success" ] || \
             [ "${{ needs.deny.result }}" != "success" ] || \
             [ "${{ needs.feature-powerset.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.security.result }}" != "success" ]; then
            echo "Some jobs failed"
            exit 1
          fi
          echo "All CI jobs passed!"
