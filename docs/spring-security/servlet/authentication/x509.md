# X.509 Authentication / X.509 认证

## Overview / 概述

X.509 certificate authentication is most commonly used when verifying the identity of a server when using SSL, most commonly when using HTTPS from a browser. The browser automatically checks that the certificate presented by the server is signed by one of the certificate authorities in its list of trusted certificate authorities.

X.509 证书认证最常用于在使用 SSL 验证服务器身份时，最常见的是从浏览器使用 HTTPS 时。浏览器会自动检查服务器提供的证书是否由其维护的受信任证书颁发机构列表中的一个颁发。

You can also use SSL with "mutual authentication". The server then requests a valid certificate from the client during the SSL handshake. The server authenticates the client by checking that the certificate is signed by an acceptable authority. If a valid certificate is provided, it can be obtained through the servlet API in your application. Spring Security's X.509 module extracts the certificate using a filter. It maps the certificate to an application user and loads that user's set of authorities for use by the standard Spring Security infrastructure.

您还可以将 SSL 与"双向身份验证"一起使用。然后，服务器在 SSL 握手过程中向客户端请求有效的证书。服务器通过检查客户端的证书是否由可接受的颁发机构签名来对客户端进行身份验证。如果提供了有效的证书，则可以通过应用程序中的 servlet API 获取它。Spring Security 的 X.509 模块使用过滤器提取证书。它将证书映射到应用程序用户，并加载该用户的授权集以供标准 Spring Security 基础设施使用。

## Adding X.509 Authentication to Your Web App / 将 X.509 认证添加到您的 Web 应用

Enabling X.509 client authentication is straightforward. Add the `<x509/>` element to your http security namespace configuration:

启用 X.509 客户端认证非常简单。将 `<x509/>` 元素添加到您的 http 安全命名空间配置中：

```xml
<http>
...
    <x509 subject-principal-regex="CN=(.*?)," user-service-ref="userService"/>
</http>
```

### Element Attributes / 元素属性

- **subject-principal-regex** - Regular expression for extracting the username from the certificate's subject name. Default pattern is shown above. This is the username that will be passed to the `UserDetailsService` to load user authorities.
- **user-service-ref** - Bean ID of the `UserDetailsService` to be used with X.509. Only required if you have more than one in your application context.

- **subject-principal-regex** - 用于从证书的主题名称中提取用户名的正则表达式。默认模式如上所示。这是将传递给 `UserDetailsService` 以加载用户授权的用户名称。
- **user-service-ref** - 要与 X.509 一起使用的 `UserDetailsService` 的 bean ID。仅当您的应用程序上下文中有多个时才需要。

### Subject Principal Regex / 主体正则表达式

The `subject-principal-regex` should contain a single group. For example, the default expression `CN=(.*?)` matches the common name field. So if the subject name in the certificate is "CN=Jimi Hendrix, OU=…", the username "Jimi Hendrix" will be extracted. Matching is case-insensitive.

`subject-principal-regex` 应该包含一个组。例如，默认表达式 `CN=(.*?)` 匹配公用名字段。因此，如果证书中的主题名称为 "CN=Jimi Hendrix, OU=…"，则会生成用户名 "Jimi Hendrix"。匹配不区分大小写。

If the client presents a certificate and a valid username is successfully extracted, there should be a valid `Authentication` object in the security context. If no certificate is found or no corresponding user is found, the security context will remain empty. This means you can use X.509 authentication with other options like form-based login.

如果客户端提供了证书并且成功提取了有效的用户名，则安全上下文中应该存在有效的 `Authentication` 对象。如果未找到证书或未找到相应的用户，则安全上下文将保持为空。这意味着您可以将 X.509 认证与其他选项（如基于表单的登录）一起使用。

## Setting Up SSL in Tomcat / 在 Tomcat 中设置 SSL

There are some pre-generated certificates in the Spring Security sample repository. You can use these to enable SSL for testing if you don't want to generate your own. The `server.jks` file contains the server certificate, private key, and CA certificate. There are also client certificate files for users from the sample application. You can install these certificates in your browser to enable SSL client authentication.

在 Spring Security 示例存储库中有一些预生成的证书。如果您不想生成自己的证书，可以使用这些证书来启用 SSL 进行测试。`server.jks` 文件包含服务器证书、私钥和颁发机构证书。还有一些来自示例应用程序的用户客户端证书文件。您可以将这些证书安装到您的浏览器中以启用 SSL 客户端认证。

### Tomcat server.xml Configuration / Tomcat server.xml 配置

To run Tomcat with SSL support, place the `server.jks` file in the tomcat `conf` directory and add the following connector to your `server.xml` file:

要使用 SSL 支持运行 tomcat，请将 `server.jks` 文件放入 tomcat `conf` 目录中，并将以下连接器添加到您的 `server.xml` 文件中：

```xml
<Connector port="8443" protocol="HTTP/1.1" SSLEnabled="true" scheme="https" secure="true"
        clientAuth="true" sslProtocol="TLS"
        keystoreFile="${catalina.home}/conf/server.jks"
        keystoreType="JKS" keystorePass="password"
        truststoreFile="${catalina.home}/conf/server.jks"
        truststoreType="JKS" truststorePass="password"/>
```

### Client Authentication Options / 客户端认证选项

- **clientAuth="true"** - Requires valid certificate from client (requires valid certificate)
- **clientAuth="want"** - SSL connection will succeed even if client doesn't provide a certificate, but clients without certificates won't be able to access Spring Security-protected objects unless you use a non-X.509 authentication mechanism (like form authentication).

- **clientAuth="true"** - 需要来自客户端的有效证书
- **clientAuth="want"** - 即使客户端未提供证书，SSL 连接也会成功，但除非您使用非 X.509 认证机制（如表单认证），否则没有证书的客户端将无法访问 Spring Security 保护的任何对象

## Java Configuration Example / Java 配置示例

```java
@Bean
public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
    http
        .authorizeHttpRequests(auth -> auth
            .anyRequest().authenticated()
        )
        .x509(x509 -> x509
            .subjectPrincipalRegex("CN=(.*?)(?:,|$)")
            .userDetailsService(userDetailsService())
        );
    return http.build();
}

@Bean
public UserDetailsService userDetailsService() {
    return new InMemoryUserDetailsManager(
        User.withUsername("client")
            .password("")  // Password not used for X.509
            .roles("USER")
            .build()
    );
}
```

*Source: https://docs.springframework.org.cn/spring-security/reference/servlet/authentication/x509.html*
